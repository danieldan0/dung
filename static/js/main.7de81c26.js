!function(t){function e(r){if(i[r])return i[r].exports;var o=i[r]={i:r,l:!1,exports:{}};return t[r].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var i={};e.m=t,e.c=i,e.i=function(t){return t},e.d=function(t,i,r){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="/dung/",e(e.s=18)}([function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=i(3),n=i.n(o),s=(i(4),i(2),i(10)),a=i(11),h=i(12),l=i(1),c=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),u=function(){function t(){r(this,t)}return c(t,[{key:"init",value:function(){window.addEventListener("load",this)}},{key:"handleEvent",value:function(t){switch(t.type){case"load":window.removeEventListener("load",this),this.scheduler=new n.a.Scheduler.Speed,this.engine=new n.a.Engine(this.scheduler),this.display=new n.a.Display({fontSize:16}),this.textBuffer=new h.a(this.display),document.body.appendChild(this.display.getContainer()),this.player=new a.a;var e=new s.a,i=e.getSize();this._switchLevel(e),this.level.setEntity(this.player,new l.a(Math.round(i.x/2),Math.round(i.y/2))),this.engine.start()}}},{key:"draw",value:function(t){var e=this.level.getEntityAt(t),i=e.getVisual();this.display.draw(t.x,t.y,i.ch,i.fg,i.bg)}},{key:"over",value:function(){this.engine.lock()}},{key:"_switchLevel",value:function(t){this.scheduler.clear(),this.level=t;var e=this.level.getSize();this.display.setOptions({width:e.x,height:e.y+3}),this.textBuffer.configure({display:this.display,position:new l.a(0,e.y),size:new l.a(e.x,3)}),this.textBuffer.clear();for(var i=new l.a,r=0;r<e.x;r++){i.x=r;for(var o=0;o<e.y;o++)i.y=o,this.draw(i)}var n=this.level.getBeings();for(var s in n)this.scheduler.add(n[s],!0)}}]),t}();u.scheduler=null,u.engine=null,u.player=null,u.level=null,u.display=null,u.textBuffer=null;var p=new u;e.a=p},function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),n=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;r(this,t),this.x=e,this.y=i}return o(t,[{key:"toString",value:function(){return this.x+","+this.y}},{key:"is",value:function(t){return this.x===t.x&&this.y===t.y}},{key:"dist8",value:function(t){var e=t.x-this.x,i=t.y-this.y;return Math.max(Math.abs(e),Math.abs(i))}},{key:"dist4",value:function(t){var e=t.x-this.x,i=t.y-this.y;return Math.abs(e)+Math.abs(i)}},{key:"dist",value:function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)}},{key:"plus",value:function(e){return new t(this.x+e.x,this.y+e.y)}},{key:"minus",value:function(e){return new t(this.x-e.x,this.y-e.y)}}]),t}();e.a=n},function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),n=function(){function t(e){r(this,t),this._visual=e,this._xy=null,this._level=null}return o(t,[{key:"getVisual",value:function(){return this._visual}},{key:"getXY",value:function(){return this._xy}},{key:"getLevel",value:function(){return this._level}},{key:"setPosition",value:function(t,e){return this._xy=t,this._level=e,this}}]),t}();e.a=n},function(t,e,i){(function(t,i){t.requestAnimationFrame=function(t){return setTimeout(t,1e3/60)},t.document={body:{appendChild:function(t){},scrollLeft:0,scrollTop:0},createElement:function(t){var e;return e={getBoundingClientRect:function(){return{left:0,top:0}},getContext:function(t){return{_termcolor:null,beginPath:function(){},canvas:e,clearRect:function(t,e,r,o){if(null!==this._termcolor){var n=this._termcolor.clearToAnsi(this.fillStyle);i.stdout.write(n)}},drawImage:function(t,e,i,r,o,n,s,a,h){},fill:function(){},fillRect:function(t,e,r,o){if(null!==this._termcolor){var n=this._termcolor.clearToAnsi(this.fillStyle);i.stdout.write(n)}},fillStyle:"#000",fillText:function(t,e,i){},font:"monospace",lineTo:function(t,e){},measureText:function(t){return{width:12}},moveTo:function(t,e){},textAlign:"center",textBaseline:"middle"}},height:0,style:{left:"100px",position:"absolute",top:"100px",visibility:"hidden"},width:0}},documentElement:{scrollLeft:0,scrollTop:0}};var r={isSupported:function(){return!(!document.createElement("canvas").getContext||!Function.prototype.bind)},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:25,DIRS:{4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},VK_CANCEL:3,VK_HELP:6,VK_BACK_SPACE:8,VK_TAB:9,VK_CLEAR:12,VK_RETURN:13,VK_ENTER:14,VK_SHIFT:16,VK_CONTROL:17,VK_ALT:18,VK_PAUSE:19,VK_CAPS_LOCK:20,VK_ESCAPE:27,VK_SPACE:32,VK_PAGE_UP:33,VK_PAGE_DOWN:34,VK_END:35,VK_HOME:36,VK_LEFT:37,VK_UP:38,VK_RIGHT:39,VK_DOWN:40,VK_PRINTSCREEN:44,VK_INSERT:45,VK_DELETE:46,VK_0:48,VK_1:49,VK_2:50,VK_3:51,VK_4:52,VK_5:53,VK_6:54,VK_7:55,VK_8:56,VK_9:57,VK_COLON:58,VK_SEMICOLON:59,VK_LESS_THAN:60,VK_EQUALS:61,VK_GREATER_THAN:62,VK_QUESTION_MARK:63,VK_AT:64,VK_A:65,VK_B:66,VK_C:67,VK_D:68,VK_E:69,VK_F:70,VK_G:71,VK_H:72,VK_I:73,VK_J:74,VK_K:75,VK_L:76,VK_M:77,VK_N:78,VK_O:79,VK_P:80,VK_Q:81,VK_R:82,VK_S:83,VK_T:84,VK_U:85,VK_V:86,VK_W:87,VK_X:88,VK_Y:89,VK_Z:90,VK_CONTEXT_MENU:93,VK_NUMPAD0:96,VK_NUMPAD1:97,VK_NUMPAD2:98,VK_NUMPAD3:99,VK_NUMPAD4:100,VK_NUMPAD5:101,VK_NUMPAD6:102,VK_NUMPAD7:103,VK_NUMPAD8:104,VK_NUMPAD9:105,VK_MULTIPLY:106,VK_ADD:107,VK_SEPARATOR:108,VK_SUBTRACT:109,VK_DECIMAL:110,VK_DIVIDE:111,VK_F1:112,VK_F2:113,VK_F3:114,VK_F4:115,VK_F5:116,VK_F6:117,VK_F7:118,VK_F8:119,VK_F9:120,VK_F10:121,VK_F11:122,VK_F12:123,VK_F13:124,VK_F14:125,VK_F15:126,VK_F16:127,VK_F17:128,VK_F18:129,VK_F19:130,VK_F20:131,VK_F21:132,VK_F22:133,VK_F23:134,VK_F24:135,VK_NUM_LOCK:144,VK_SCROLL_LOCK:145,VK_CIRCUMFLEX:160,VK_EXCLAMATION:161,VK_DOUBLE_QUOTE:162,VK_HASH:163,VK_DOLLAR:164,VK_PERCENT:165,VK_AMPERSAND:166,VK_UNDERSCORE:167,VK_OPEN_PAREN:168,VK_CLOSE_PAREN:169,VK_ASTERISK:170,VK_PLUS:171,VK_PIPE:172,VK_HYPHEN_MINUS:173,VK_OPEN_CURLY_BRACKET:174,VK_CLOSE_CURLY_BRACKET:175,VK_TILDE:176,VK_COMMA:188,VK_PERIOD:190,VK_SLASH:191,VK_BACK_QUOTE:192,VK_OPEN_BRACKET:219,VK_BACK_SLASH:220,VK_CLOSE_BRACKET:221,VK_QUOTE:222,VK_META:224,VK_ALTGR:225,VK_WIN:91,VK_KANA:21,VK_HANGUL:21,VK_EISU:22,VK_JUNJA:23,VK_FINAL:24,VK_HANJA:25,VK_KANJI:25,VK_CONVERT:28,VK_NONCONVERT:29,VK_ACCEPT:30,VK_MODECHANGE:31,VK_SELECT:41,VK_PRINT:42,VK_EXECUTE:43,VK_SLEEP:95};r.Text={RE_COLORS:/%([bc]){([^}]*)}/g,TYPE_TEXT:0,TYPE_NEWLINE:1,TYPE_FG:2,TYPE_BG:3,measure:function(t,e){for(var i={width:0,height:1},r=this.tokenize(t,e),o=0,n=0;n<r.length;n++){var s=r[n];switch(s.type){case this.TYPE_TEXT:o+=s.value.length;break;case this.TYPE_NEWLINE:i.height++,i.width=Math.max(i.width,o),o=0}}return i.width=Math.max(i.width,o),i},tokenize:function(t,e){var i=[],o=0;t.replace(this.RE_COLORS,function(e,n,s,a){var h=t.substring(o,a);return h.length&&i.push({type:r.Text.TYPE_TEXT,value:h}),i.push({type:"c"==n?r.Text.TYPE_FG:r.Text.TYPE_BG,value:s.trim()}),o=a+e.length,""});var n=t.substring(o);return n.length&&i.push({type:r.Text.TYPE_TEXT,value:n}),this._breakLines(i,e)},_breakLines:function(t,e){e||(e=1/0);for(var i=0,o=0,n=-1;i<t.length;){var s=t[i];if(s.type==r.Text.TYPE_NEWLINE&&(o=0,n=-1),s.type==r.Text.TYPE_TEXT){for(;0==o&&" "==s.value.charAt(0);)s.value=s.value.substring(1);var a=s.value.indexOf("\n");if(-1!=a){s.value=this._breakInsideToken(t,i,a,!0);for(var h=s.value.split("");h.length&&" "==h[h.length-1];)h.pop();s.value=h.join("")}if(s.value.length){if(o+s.value.length>e){for(var a=-1;;){var l=s.value.indexOf(" ",a+1);if(-1==l)break;if(o+l>e)break;a=l}if(-1!=a)s.value=this._breakInsideToken(t,i,a,!0);else if(-1!=n){var s=t[n],c=s.value.lastIndexOf(" ");s.value=this._breakInsideToken(t,n,c,!0),i=n}else s.value=this._breakInsideToken(t,i,e-o,!1)}else o+=s.value.length,-1!=s.value.indexOf(" ")&&(n=i);i++}else t.splice(i,1)}else i++}t.push({type:r.Text.TYPE_NEWLINE});for(var u=null,i=0;i<t.length;i++){var s=t[i];switch(s.type){case r.Text.TYPE_TEXT:u=s;break;case r.Text.TYPE_NEWLINE:if(u){for(var h=u.value.split("");h.length&&" "==h[h.length-1];)h.pop();u.value=h.join("")}u=null}}return t.pop(),t},_breakInsideToken:function(t,e,i,o){var n={type:r.Text.TYPE_NEWLINE},s={type:r.Text.TYPE_TEXT,value:t[e].value.substring(i+(o?1:0))};return t.splice(e+1,0,n,s),t[e].value.substring(0,i)}},Array.prototype.random=Array.prototype.random||function(){return this.length?this[Math.floor(r.RNG.getUniform()*this.length)]:null},Array.prototype.randomize=Array.prototype.randomize||function(){for(var t=[];this.length;){var e=this.indexOf(this.random());t.push(this.splice(e,1)[0])}return t},Number.prototype.mod=Number.prototype.mod||function(t){return(this%t+t)%t},String.prototype.capitalize=String.prototype.capitalize||function(){return this.charAt(0).toUpperCase()+this.substring(1)},String.prototype.lpad=String.prototype.lpad||function(t,e){for(var i=t||"0",r=e||2,o="";o.length<r-this.length;)o+=i;return(o=o.substring(0,r-this.length))+this},String.prototype.rpad=String.prototype.rpad||function(t,e){for(var i=t||"0",r=e||2,o="";o.length<r-this.length;)o+=i;return o=o.substring(0,r-this.length),this+o},String.format=String.format||function(t){var e=String.format.map,i=Array.prototype.slice.call(arguments,1),r=function(r,o,n,s){if("%"==t.charAt(s-1))return r.substring(1);if(!i.length)return r;var a=i[0],h=o||n,l=h.split(","),c=l.shift(),u=e[c.toLowerCase()];if(!u)return r;var a=i.shift(),p=a[u].apply(a,l),f=c.charAt(0);return f!=f.toLowerCase()&&(p=p.capitalize()),p};return t.replace(/%(?:([a-z]+)|(?:{([^}]+)}))/gi,r)},String.format.map=String.format.map||{s:"toString"},String.prototype.format=String.prototype.format||function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this),String.format.apply(String,t)},Object.create||(Object.create=function(t){var e=function(){};return e.prototype=t,new e}),Function.prototype.extend=Function.prototype.extend||function(t){return this.prototype=Object.create(t.prototype),this.prototype.constructor=this,this},"undefined"!=typeof window&&(window.requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return setTimeout(t,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.oCancelAnimationFrame||window.msCancelAnimationFrame||function(t){return clearTimeout(t)}),r.Display=function(t){var e=document.createElement("canvas");this._context=e.getContext("2d"),this._data={},this._dirty=!1,this._options={},this._backend=null;var i={width:r.DEFAULT_WIDTH,height:r.DEFAULT_HEIGHT,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1,termColor:"xterm"};for(var o in t)i[o]=t[o];this.setOptions(i),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),requestAnimationFrame(this._tick)},r.Display.prototype.DEBUG=function(t,e,i){var r=[this._options.bg,this._options.fg];this.draw(t,e,null,null,r[i%r.length])},r.Display.prototype.clear=function(){this._data={},this._dirty=!0},r.Display.prototype.setOptions=function(t){for(var e in t)this._options[e]=t[e];if(t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){t.layout&&(this._backend=new(r.Display[t.layout.capitalize()])(this._context));var i=(this._options.fontStyle?this._options.fontStyle+" ":"")+this._options.fontSize+"px "+this._options.fontFamily;this._context.font=i,this._backend.compute(this._options),this._context.font=i,this._context.textAlign="center",this._context.textBaseline="middle",this._dirty=!0}return this},r.Display.prototype.getOptions=function(){return this._options},r.Display.prototype.getContainer=function(){return this._context.canvas},r.Display.prototype.computeSize=function(t,e){return this._backend.computeSize(t,e,this._options)},r.Display.prototype.computeFontSize=function(t,e){return this._backend.computeFontSize(t,e,this._options)},r.Display.prototype.eventToPosition=function(t){if(t.touches)var e=t.touches[0].clientX,i=t.touches[0].clientY;else var e=t.clientX,i=t.clientY;var r=this._context.canvas.getBoundingClientRect();return e-=r.left,i-=r.top,e<0||i<0||e>=this._context.canvas.width||i>=this._context.canvas.height?[-1,-1]:this._backend.eventToPosition(e,i)},r.Display.prototype.draw=function(t,e,i,r,o){r||(r=this._options.fg),o||(o=this._options.bg),this._data[t+","+e]=[t,e,i,r,o],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[t+","+e]=!0)},r.Display.prototype.drawText=function(t,e,i,o){var n=null,s=null,a=t,h=e,l=1;o||(o=this._options.width-t);for(var c=r.Text.tokenize(i,o);c.length;){var u=c.shift();switch(u.type){case r.Text.TYPE_TEXT:for(var p=!1,f=!1,_=!1,d=!1,y=0;y<u.value.length;y++){var g=u.value.charCodeAt(y),v=u.value.charAt(y);_=g>255&&g<65377||g>65500&&g<65512&&g>65518,p=32==v.charCodeAt(0)||12288==v.charCodeAt(0),!d||_||p||a++,_&&!f&&a++,this.draw(a++,h,v,n,s),f=p,d=_}break;case r.Text.TYPE_FG:n=u.value||null;break;case r.Text.TYPE_BG:s=u.value||null;break;case r.Text.TYPE_NEWLINE:a=t,h++,l++}}return l},r.Display.prototype._tick=function(){if(requestAnimationFrame(this._tick),this._dirty){if(!0===this._dirty){this._context.fillStyle=this._options.bg,this._context.fillRect(0,0,this._context.canvas.width,this._context.canvas.height);for(var t in this._data)this._draw(t,!1)}else for(var e in this._dirty)this._draw(e,!0);this._dirty=!1}},r.Display.prototype._draw=function(t,e){var i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)},r.Display.Backend=function(t){this._context=t},r.Display.Backend.prototype.compute=function(t){},r.Display.Backend.prototype.draw=function(t,e){},r.Display.Backend.prototype.computeSize=function(t,e){},r.Display.Backend.prototype.computeFontSize=function(t,e){},r.Display.Backend.prototype.eventToPosition=function(t,e){},r.Display.Rect=function(t){r.Display.Backend.call(this,t),this._spacingX=0,this._spacingY=0,this._canvasCache={},this._options={}},r.Display.Rect.extend(r.Display.Backend),r.Display.Rect.cache=!1,r.Display.Rect.prototype.compute=function(t){this._canvasCache={},this._options=t;var e=Math.ceil(this._context.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),this._options.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._context.canvas.width=t.width*this._spacingX,this._context.canvas.height=t.height*this._spacingY},r.Display.Rect.prototype.draw=function(t,e){this.constructor.cache?this._drawWithCache(t,e):this._drawNoCache(t,e)},r.Display.Rect.prototype._drawWithCache=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=""+o+n+s;if(a in this._canvasCache)var h=this._canvasCache[a];else{var l=this._options.border,h=document.createElement("canvas"),c=h.getContext("2d");if(h.width=this._spacingX,h.height=this._spacingY,c.fillStyle=s,c.fillRect(l,l,h.width-l,h.height-l),o){c.fillStyle=n,c.font=this._context.font,c.textAlign="center",c.textBaseline="middle";for(var u=[].concat(o),p=0;p<u.length;p++)c.fillText(u[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=h}this._context.drawImage(h,i*this._spacingX,r*this._spacingY)},r.Display.Rect.prototype._drawNoCache=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4];if(e){var a=this._options.border;this._context.fillStyle=s,this._context.fillRect(i*this._spacingX+a,r*this._spacingY+a,this._spacingX-a,this._spacingY-a)}if(o){this._context.fillStyle=n;for(var h=[].concat(o),l=0;l<h.length;l++)this._context.fillText(h[l],(i+.5)*this._spacingX,Math.ceil((r+.5)*this._spacingY))}},r.Display.Rect.prototype.computeSize=function(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]},r.Display.Rect.prototype.computeFontSize=function(t,e){var i=Math.floor(t/this._options.width),r=Math.floor(e/this._options.height),o=this._context.font;this._context.font="100px "+this._options.fontFamily;var n=Math.ceil(this._context.measureText("W").width);this._context.font=o;var s=n/100,a=s*r/i;return a>1&&(r=Math.floor(r/a)),Math.floor(r/this._options.spacing)},r.Display.Rect.prototype.eventToPosition=function(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]},r.Display.Hex=function(t){r.Display.Backend.call(this,t),this._spacingX=0,this._spacingY=0,this._hexSize=0,this._options={}},r.Display.Hex.extend(r.Display.Backend),r.Display.Hex.prototype.compute=function(t){this._options=t;var e=Math.ceil(this._context.measureText("W").width);if(this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose)var i="height",r="width";else var i="width",r="height";this._context.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._context.canvas[r]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)},r.Display.Hex.prototype.draw=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=[(i+1)*this._spacingX,r*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._context.fillStyle=s,this._fill(a[0],a[1])),o){this._context.fillStyle=n;for(var h=[].concat(o),l=0;l<h.length;l++)this._context.fillText(h[l],a[0],Math.ceil(a[1]))}},r.Display.Hex.prototype.computeSize=function(t,e){return this._options.transpose&&(t+=e,e=t-e,t-=e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]},r.Display.Hex.prototype.computeFontSize=function(t,e){this._options.transpose&&(t+=e,e=t-e,t-=e);var i=2*t/((this._options.width+1)*Math.sqrt(3))-1,r=e/(2+1.5*(this._options.height-1)),o=Math.min(i,r),n=this._context.font;this._context.font="100px "+this._options.fontFamily;var s=Math.ceil(this._context.measureText("W").width);this._context.font=n;var a=s/100;o=Math.floor(o)+1;var h=2*o/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(h)-1},r.Display.Hex.prototype.eventToPosition=function(t,e){if(this._options.transpose){t+=e,e=t-e,t-=e;var i="width"}else var i="height";var r=this._context.canvas[i]/this._options[i];return e=Math.floor(e/r),e.mod(2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]},r.Display.Hex.prototype._fill=function(t,e){var i=this._hexSize,r=this._options.border;this._context.beginPath(),this._options.transpose?(this._context.moveTo(t-i+r,e),this._context.lineTo(t-i/2+r,e+this._spacingX-r),this._context.lineTo(t+i/2-r,e+this._spacingX-r),this._context.lineTo(t+i-r,e),this._context.lineTo(t+i/2-r,e-this._spacingX+r),this._context.lineTo(t-i/2+r,e-this._spacingX+r),this._context.lineTo(t-i+r,e)):(this._context.moveTo(t,e-i+r),this._context.lineTo(t+this._spacingX-r,e-i/2+r),this._context.lineTo(t+this._spacingX-r,e+i/2-r),this._context.lineTo(t,e+i-r),this._context.lineTo(t-this._spacingX+r,e+i/2-r),this._context.lineTo(t-this._spacingX+r,e-i/2+r),this._context.lineTo(t,e-i+r)),this._context.fill()},r.Display.Tile=function(t){r.Display.Rect.call(this,t),this._options={},this._colorCanvas=document.createElement("canvas")},r.Display.Tile.extend(r.Display.Rect),r.Display.Tile.prototype.compute=function(t){this._options=t,this._context.canvas.width=t.width*t.tileWidth,this._context.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight},r.Display.Tile.prototype.draw=function(t,e){var i=t[0],r=t[1],o=t[2],n=t[3],s=t[4],a=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._context.clearRect(i*a,r*h,a,h):(this._context.fillStyle=s,this._context.fillRect(i*a,r*h,a,h))),o)for(var l=[].concat(o),c=0;c<l.length;c++){var u=this._options.tileMap[l[c]];if(!u)throw new Error("Char '"+l[c]+"' not found in tileMap");if(this._options.tileColorize){var p=this._colorCanvas,f=p.getContext("2d");f.clearRect(0,0,a,h),f.drawImage(this._options.tileSet,u[0],u[1],a,h,0,0,a,h),"transparent"!=n&&(f.fillStyle=n,f.globalCompositeOperation="source-atop",f.fillRect(0,0,a,h)),"transparent"!=s&&(f.fillStyle=s,f.globalCompositeOperation="destination-over",f.fillRect(0,0,a,h)),this._context.drawImage(p,i*a,r*h,a,h)}else this._context.drawImage(this._options.tileSet,u[0],u[1],a,h,i*a,r*h,a,h)}},r.Display.Tile.prototype.computeSize=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},r.Display.Tile.prototype.computeFontSize=function(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]},r.Display.Tile.prototype.eventToPosition=function(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]},r.RNG={getSeed:function(){return this._seed},setSeed:function(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*this._frac,t=69069*t+1>>>0,this._s1=t*this._frac,t=69069*t+1>>>0,this._s2=t*this._frac,this._c=1,this},getUniform:function(){var t=2091639*this._s0+this._c*this._frac;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2},getUniformInt:function(t,e){var i=Math.max(t,e),r=Math.min(t,e);return Math.floor(this.getUniform()*(i-r+1))+r},getNormal:function(t,e){do{var i=2*this.getUniform()-1,r=2*this.getUniform()-1,o=i*i+r*r}while(o>1||0==o);var n=i*Math.sqrt(-2*Math.log(o)/o);return(t||0)+n*(e||1)},getPercentage:function(){return 1+Math.floor(100*this.getUniform())},getWeightedValue:function(t){var e=0;for(var i in t)e+=t[i];var r=this.getUniform()*e,o=0;for(var i in t)if(o+=t[i],r<o)return i;return i},getState:function(){return[this._s0,this._s1,this._s2,this._c]},setState:function(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this},clone:function(){var t=Object.create(this);return t.setState(this.getState()),t},_s0:0,_s1:0,_s2:0,_c:0,_frac:2.3283064365386963e-10},r.RNG.setSeed(Date.now()),r.StringGenerator=function(t){this._options={words:!1,order:3,prior:.001};for(var e in t)this._options[e]=t[e];this._boundary=String.fromCharCode(0),this._suffix=this._boundary,this._prefix=[];for(var i=0;i<this._options.order;i++)this._prefix.push(this._boundary);this._priorValues={},this._priorValues[this._boundary]=this._options.prior,this._data={}},r.StringGenerator.prototype.clear=function(){this._data={},this._priorValues={}},r.StringGenerator.prototype.generate=function(){for(var t=[this._sample(this._prefix)];t[t.length-1]!=this._boundary;)t.push(this._sample(t));return this._join(t.slice(0,-1))},r.StringGenerator.prototype.observe=function(t){for(var e=this._split(t),i=0;i<e.length;i++)this._priorValues[e[i]]=this._options.prior;e=this._prefix.concat(e).concat(this._suffix);for(var i=this._options.order;i<e.length;i++)for(var r=e.slice(i-this._options.order,i),o=e[i],n=0;n<r.length;n++){var s=r.slice(n);this._observeEvent(s,o)}},r.StringGenerator.prototype.getStats=function(){var t=[],e=0;for(var i in this._priorValues)e++;e--,t.push("distinct samples: "+e);var r=0,o=0;for(var i in this._data){r++;for(var n in this._data[i])o++}return t.push("dictionary size (contexts): "+r),t.push("dictionary size (events): "+o),t.join(", ")},r.StringGenerator.prototype._split=function(t){return t.split(this._options.words?/\s+/:"")},r.StringGenerator.prototype._join=function(t){return t.join(this._options.words?" ":"")},r.StringGenerator.prototype._observeEvent=function(t,e){var i=this._join(t);i in this._data||(this._data[i]={});var r=this._data[i];e in r||(r[e]=0),r[e]++},r.StringGenerator.prototype._sample=function(t){t=this._backoff(t);var e=this._join(t),i=this._data[e],o={};if(this._options.prior){for(var n in this._priorValues)o[n]=this._priorValues[n];for(var n in i)o[n]+=i[n]}else o=i;return r.RNG.getWeightedValue(o)},r.StringGenerator.prototype._backoff=function(t){for(t.length>this._options.order?t=t.slice(-this._options.order):t.length<this._options.order&&(t=this._prefix.slice(0,this._options.order-t.length).concat(t));!(this._join(t)in this._data)&&t.length>0;)t=t.slice(1);return t},r.EventQueue=function(){this._time=0,this._events=[],this._eventTimes=[]},r.EventQueue.prototype.getTime=function(){return this._time},r.EventQueue.prototype.clear=function(){return this._events=[],this._eventTimes=[],this},r.EventQueue.prototype.add=function(t,e){for(var i=this._events.length,r=0;r<this._eventTimes.length;r++)if(this._eventTimes[r]>e){i=r;break}this._events.splice(i,0,t),this._eventTimes.splice(i,0,e)},r.EventQueue.prototype.get=function(){if(!this._events.length)return null;var t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(var e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]},r.EventQueue.prototype.remove=function(t){var e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)},r.EventQueue.prototype._remove=function(t){this._events.splice(t,1),this._eventTimes.splice(t,1)},r.Scheduler=function(){this._queue=new r.EventQueue,this._repeat=[],this._current=null},r.Scheduler.prototype.getTime=function(){return this._queue.getTime()},r.Scheduler.prototype.add=function(t,e){return e&&this._repeat.push(t),this},r.Scheduler.prototype.clear=function(){return this._queue.clear(),this._repeat=[],this._current=null,this},r.Scheduler.prototype.remove=function(t){var e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e},r.Scheduler.prototype.next=function(){return this._current=this._queue.get(),this._current},r.Scheduler.Simple=function(){r.Scheduler.call(this)},r.Scheduler.Simple.extend(r.Scheduler),r.Scheduler.Simple.prototype.add=function(t,e){return this._queue.add(t,0),r.Scheduler.prototype.add.call(this,t,e)},r.Scheduler.Simple.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),r.Scheduler.prototype.next.call(this)},r.Scheduler.Speed=function(){r.Scheduler.call(this)},r.Scheduler.Speed.extend(r.Scheduler),r.Scheduler.Speed.prototype.add=function(t,e){return this._queue.add(t,1/t.getSpeed()),r.Scheduler.prototype.add.call(this,t,e)},r.Scheduler.Speed.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),r.Scheduler.prototype.next.call(this)},r.Scheduler.Action=function(){r.Scheduler.call(this),this._defaultDuration=1,this._duration=this._defaultDuration},r.Scheduler.Action.extend(r.Scheduler),r.Scheduler.Action.prototype.add=function(t,e,i){return this._queue.add(t,i||this._defaultDuration),r.Scheduler.prototype.add.call(this,t,e)},r.Scheduler.Action.prototype.clear=function(){return this._duration=this._defaultDuration,r.Scheduler.prototype.clear.call(this)},r.Scheduler.Action.prototype.remove=function(t){return t==this._current&&(this._duration=this._defaultDuration),r.Scheduler.prototype.remove.call(this,t)},r.Scheduler.Action.prototype.next=function(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),r.Scheduler.prototype.next.call(this)},r.Scheduler.Action.prototype.setDuration=function(t){return this._current&&(this._duration=t),this},r.Engine=function(t){this._scheduler=t,this._lock=1},r.Engine.prototype.start=function(){return this.unlock()},r.Engine.prototype.lock=function(){return this._lock++,this},r.Engine.prototype.unlock=function(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){var t=this._scheduler.next();if(!t)return this.lock();var e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this},r.Map=function(t,e){this._width=t||r.DEFAULT_WIDTH,this._height=e||r.DEFAULT_HEIGHT},r.Map.prototype.create=function(t){},r.Map.prototype._fillMap=function(t){for(var e=[],i=0;i<this._width;i++){e.push([]);for(var r=0;r<this._height;r++)e[i].push(t)}return e},r.Map.Arena=function(t,e){r.Map.call(this,t,e)},r.Map.Arena.extend(r.Map),r.Map.Arena.prototype.create=function(t){for(var e=this._width-1,i=this._height-1,r=0;r<=e;r++)for(var o=0;o<=i;o++){var n=r&&o&&r<e&&o<i;t(r,o,n?0:1)}return this},r.Map.DividedMaze=function(t,e){r.Map.call(this,t,e),this._stack=[]},r.Map.DividedMaze.extend(r.Map),r.Map.DividedMaze.prototype.create=function(t){var e=this._width,i=this._height;this._map=[];for(var r=0;r<e;r++){this._map.push([]);for(var o=0;o<i;o++){var n=0==r||0==o||r+1==e||o+1==i;this._map[r].push(n?1:0)}}this._stack=[[1,1,e-2,i-2]],this._process();for(var r=0;r<e;r++)for(var o=0;o<i;o++)t(r,o,this._map[r][o]);return this._map=null,this},r.Map.DividedMaze.prototype._process=function(){for(;this._stack.length;){var t=this._stack.shift();this._partitionRoom(t)}},r.Map.DividedMaze.prototype._partitionRoom=function(t){for(var e=[],i=[],r=t[0]+1;r<t[2];r++){var o=this._map[r][t[1]-1],n=this._map[r][t[3]+1];!o||!n||r%2||e.push(r)}for(var s=t[1]+1;s<t[3];s++){var a=this._map[t[0]-1][s],h=this._map[t[2]+1][s];!a||!h||s%2||i.push(s)}if(e.length&&i.length){var l=e.random(),c=i.random();this._map[l][c]=1;var u=[],p=[];u.push(p);for(var r=t[0];r<l;r++)this._map[r][c]=1,p.push([r,c]);var p=[];u.push(p);for(var r=l+1;r<=t[2];r++)this._map[r][c]=1,p.push([r,c]);var p=[];u.push(p);for(var s=t[1];s<c;s++)this._map[l][s]=1,p.push([l,s]);var p=[];u.push(p);for(var s=c+1;s<=t[3];s++)this._map[l][s]=1,p.push([l,s]);for(var f=u.random(),r=0;r<u.length;r++){var p=u[r];if(p!=f){var _=p.random();this._map[_[0]][_[1]]=0}}this._stack.push([t[0],t[1],l-1,c-1]),this._stack.push([l+1,t[1],t[2],c-1]),this._stack.push([t[0],c+1,l-1,t[3]]),this._stack.push([l+1,c+1,t[2],t[3]])}},r.Map.IceyMaze=function(t,e,i){r.Map.call(this,t,e),this._regularity=i||0},r.Map.IceyMaze.extend(r.Map),r.Map.IceyMaze.prototype.create=function(t){var e=this._width,i=this._height,o=this._fillMap(1);e-=e%2?1:2,i-=i%2?1:2;var n=0,s=0,a=0,h=0,l=0,c=!1,u=[[0,0],[0,0],[0,0],[0,0]];do{if(n=1+2*Math.floor(r.RNG.getUniform()*(e-1)/2),s=1+2*Math.floor(r.RNG.getUniform()*(i-1)/2),l||(o[n][s]=0),!o[n][s]){this._randomize(u);do{0==Math.floor(r.RNG.getUniform()*(this._regularity+1))&&this._randomize(u),c=!0;for(var p=0;p<4;p++)if(a=n+2*u[p][0],h=s+2*u[p][1],this._isFree(o,a,h,e,i)){o[a][h]=0,o[n+u[p][0]][s+u[p][1]]=0,n=a,s=h,c=!1,l++;break}}while(!c)}}while(l+1<e*i/4);for(var p=0;p<this._width;p++)for(var f=0;f<this._height;f++)t(p,f,o[p][f]);return this._map=null,this},r.Map.IceyMaze.prototype._randomize=function(t){for(var e=0;e<4;e++)t[e][0]=0,t[e][1]=0;switch(Math.floor(4*r.RNG.getUniform())){case 0:t[0][0]=-1,t[1][0]=1,t[2][1]=-1,t[3][1]=1;break;case 1:t[3][0]=-1,t[2][0]=1,t[1][1]=-1,t[0][1]=1;break;case 2:t[2][0]=-1,t[3][0]=1,t[0][1]=-1,t[1][1]=1;break;case 3:t[1][0]=-1,t[0][0]=1,t[3][1]=-1,t[2][1]=1}},r.Map.IceyMaze.prototype._isFree=function(t,e,i,r,o){return!(e<1||i<1||e>=r||i>=o)&&t[e][i]},r.Map.EllerMaze=function(t,e){r.Map.call(this,t,e)},r.Map.EllerMaze.extend(r.Map),r.Map.EllerMaze.prototype.create=function(t){for(var e=this._fillMap(1),i=Math.ceil((this._width-2)/2),o=[],n=[],s=0;s<i;s++)o.push(s),n.push(s);o.push(i-1);for(var a=1;a+3<this._height;a+=2)for(var s=0;s<i;s++){var h=2*s+1,l=a;e[h][l]=0,s!=o[s+1]&&r.RNG.getUniform()>.375&&(this._addToList(s,o,n),e[h+1][l]=0),s!=o[s]&&r.RNG.getUniform()>.375?this._removeFromList(s,o,n):e[h][l+1]=0}for(var s=0;s<i;s++){var h=2*s+1,l=a;e[h][l]=0,s!=o[s+1]&&(s==o[s]||r.RNG.getUniform()>.375)&&(this._addToList(s,o,n),e[h+1][l]=0),this._removeFromList(s,o,n)}for(var s=0;s<this._width;s++)for(var a=0;a<this._height;a++)t(s,a,e[s][a]);return this},r.Map.EllerMaze.prototype._removeFromList=function(t,e,i){i[e[t]]=i[t],e[i[t]]=e[t],i[t]=t,e[t]=t},r.Map.EllerMaze.prototype._addToList=function(t,e,i){i[e[t+1]]=i[t],e[i[t]]=e[t+1],i[t]=t+1,e[t+1]=t},r.Map.Cellular=function(t,e,i){r.Map.call(this,t,e),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8,connected:!1},this.setOptions(i),this._dirs=r.DIRS[this._options.topology],this._map=this._fillMap(0)},r.Map.Cellular.extend(r.Map),r.Map.Cellular.prototype.randomize=function(t){for(var e=0;e<this._width;e++)for(var i=0;i<this._height;i++)this._map[e][i]=r.RNG.getUniform()<t?1:0;return this},r.Map.Cellular.prototype.setOptions=function(t){for(var e in t)this._options[e]=t[e]},r.Map.Cellular.prototype.set=function(t,e,i){this._map[t][e]=i},r.Map.Cellular.prototype.create=function(t){for(var e=this._fillMap(0),i=this._options.born,r=this._options.survive,o=0;o<this._height;o++){var n=1,s=0;6==this._options.topology&&(n=2,s=o%2);for(var a=s;a<this._width;a+=n){var h=this._map[a][o],l=this._getNeighbors(a,o);h&&-1!=r.indexOf(l)?e[a][o]=1:h||-1==i.indexOf(l)||(e[a][o]=1)}}if(this._map=e,this._options.connected&&this._completeMaze(),t)for(var o=0;o<this._height;o++){var n=1,s=0;6==this._options.topology&&(n=2,s=o%2);for(var a=s;a<this._width;a+=n)t(a,o,e[a][o])}},r.Map.Cellular.prototype._getNeighbors=function(t,e){for(var i=0,r=0;r<this._dirs.length;r++){var o=this._dirs[r],n=t+o[0],s=e+o[1];n<0||n>=this._width||n<0||s>=this._width||(i+=1==this._map[n][s]?1:0)}return i},r.Map.Cellular.prototype._completeMaze=function(){for(var t=[],e={},i=0;i<this._width;i++)for(var o=0;o<this._height;o++)if(this._freeSpace(i,o)){var n=[i,o];e[this._pointKey(n)]=n,t.push([i,o])}var s=t[r.RNG.getUniformInt(0,t.length-1)],a=this._pointKey(s),h={};for(h[a]=s,delete e[a],this._findConnected(h,e,[s]);Object.keys(e).length>0;){var n=this._getFromTo(h,e),l=n[0],c=n[1],u={};u[this._pointKey(l)]=l,this._findConnected(u,e,[l],!0),this._tunnelToConnected(c,l,h,e);for(var p in u){var f=u[p];this._map[f[0]][f[1]]=0,h[p]=f,delete e[p]}}},r.Map.Cellular.prototype._getFromTo=function(t,e){for(var i,o,n=Object.keys(t),s=Object.keys(e),a=0;a<5;a++){if(n.length<s.length){var h=n;o=t[h[r.RNG.getUniformInt(0,h.length-1)]],i=this._getClosest(o,e)}else{var h=s;i=e[h[r.RNG.getUniformInt(0,h.length-1)]],o=this._getClosest(i,t)}if((i[0]-o[0])*(i[0]-o[0])+(i[1]-o[1])*(i[1]-o[1])<64)break}return[i,o]},r.Map.Cellular.prototype._getClosest=function(t,e){var i=null,r=null;for(k in e){var o=e[k],n=(o[0]-t[0])*(o[0]-t[0])+(o[1]-t[1])*(o[1]-t[1]);(null==r||n<r)&&(r=n,i=o)}return i},r.Map.Cellular.prototype._findConnected=function(t,e,i,r){for(;i.length>0;)for(var o=i.splice(0,1)[0],n=[[o[0]+1,o[1]],[o[0]-1,o[1]],[o[0],o[1]+1],[o[0],o[1]-1]],s=0;s<n.length;s++){var a=this._pointKey(n[s]);null==t[a]&&this._freeSpace(n[s][0],n[s][1])&&(t[a]=n[s],r||delete e[a],i.push(n[s]))}},r.Map.Cellular.prototype._tunnelToConnected=function(t,e,i,r){var o,n;this._pointKey(e);e[0]<t[0]?(o=e,n=t):(o=t,n=e);for(var s=o[0];s<=n[0];s++){this._map[s][o[1]]=0;var a=[s,o[1]],h=this._pointKey(a);i[h]=a,delete r[h]}var l=n[0];e[1]<t[1]?(o=e,n=t):(o=t,n=e);for(var c=o[1];c<n[1];c++){this._map[l][c]=0;var a=[l,c],h=this._pointKey(a);i[h]=a,delete r[h]}},r.Map.Cellular.prototype._freeSpace=function(t,e){return t>=0&&t<this._width&&e>=0&&e<this._height&&1!=this._map[t][e]},r.Map.Cellular.prototype._pointKey=function(t){return t[0]+"."+t[1]},r.Map.Dungeon=function(t,e){r.Map.call(this,t,e),this._rooms=[],this._corridors=[]},r.Map.Dungeon.extend(r.Map),r.Map.Dungeon.prototype.getRooms=function(){return this._rooms},r.Map.Dungeon.prototype.getCorridors=function(){return this._corridors},r.Map.Digger=function(t,e,i){r.Map.Dungeon.call(this,t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3};for(var o in i)this._options[o]=i[o];this._features={Room:4,Corridor:4},this._featureAttempts=20,this._walls={},this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)},r.Map.Digger.extend(r.Map.Dungeon),r.Map.Digger.prototype.create=function(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;var e=(this._width-2)*(this._height-2);this._firstRoom();var i=Date.now();do{if(Date.now()-i>this._options.timeLimit)break;var r=this._findWall();if(!r)break;var o=r.split(","),n=parseInt(o[0]),s=parseInt(o[1]),a=this._getDiggingDirection(n,s);if(a){var h=0;do{if(h++,this._tryFeature(n,s,a[0],a[1])){this._removeSurroundingWalls(n,s),this._removeSurroundingWalls(n-a[0],s-a[1]);break}}while(h<this._featureAttempts);var l=0;for(var c in this._walls)this._walls[c]>1&&l++}}while(this._dug/e<this._options.dugPercentage||l);if(this._addDoors(),t)for(var u=0;u<this._width;u++)for(var p=0;p<this._height;p++)t(u,p,this._map[u][p]);return this._walls={},this._map=null,this},r.Map.Digger.prototype._digCallback=function(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1},r.Map.Digger.prototype._isWallCallback=function(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]},r.Map.Digger.prototype._canBeDugCallback=function(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]},r.Map.Digger.prototype._priorityWallCallback=function(t,e){this._walls[t+","+e]=2},r.Map.Digger.prototype._firstRoom=function(){var t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=r.Map.Feature.Room.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)},r.Map.Digger.prototype._findWall=function(){var t=[],e=[];for(var i in this._walls){2==this._walls[i]?e.push(i):t.push(i)}var r=e.length?e:t;if(!r.length)return null;var i=r.random();return delete this._walls[i],i},r.Map.Digger.prototype._tryFeature=function(t,e,i,o){var n=r.RNG.getWeightedValue(this._features);return n=r.Map.Feature[n].createRandomAt(t,e,i,o,this._options),!!n.isValid(this._isWallCallback,this._canBeDugCallback)&&(n.create(this._digCallback),n instanceof r.Map.Feature.Room&&this._rooms.push(n),n instanceof r.Map.Feature.Corridor&&(n.createPriorityWalls(this._priorityWallCallback),this._corridors.push(n)),!0)},r.Map.Digger.prototype._removeSurroundingWalls=function(t,e){for(var i=r.DIRS[4],o=0;o<i.length;o++){var n=i[o],s=t+n[0],a=e+n[1];delete this._walls[s+","+a];var s=t+2*n[0],a=e+2*n[1];delete this._walls[s+","+a]}},r.Map.Digger.prototype._getDiggingDirection=function(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;for(var i=null,o=r.DIRS[4],n=0;n<o.length;n++){var s=o[n],a=t+s[0],h=e+s[1];if(!this._map[a][h]){if(i)return null;i=s}}return i?[-i[0],-i[1]]:null},r.Map.Digger.prototype._addDoors=function(){for(var t=this._map,e=function(e,i){return 1==t[e][i]},i=0;i<this._rooms.length;i++){var r=this._rooms[i];r.clearDoors(),r.addDoors(e)}},r.Map.Uniform=function(t,e,i){r.Map.Dungeon.call(this,t,e),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3};for(var o in i)this._options[o]=i[o];this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)},r.Map.Uniform.extend(r.Map.Dungeon),r.Map.Uniform.prototype.create=function(t){for(var e=Date.now();;){if(Date.now()-e>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(t)for(var i=0;i<this._width;i++)for(var r=0;r<this._height;r++)t(i,r,this._map[i][r]);return this},r.Map.Uniform.prototype._generateRooms=function(){var t=this._width-2,e=this._height-2;do{var i=this._generateRoom();if(this._dug/(t*e)>this._options.roomDugPercentage)break}while(i)},r.Map.Uniform.prototype._generateRoom=function(){for(var t=0;t<this._roomAttempts;){t++;var e=r.Map.Feature.Room.createRandom(this._width,this._height,this._options);if(e.isValid(this._isWallCallback,this._canBeDugCallback))return e.create(this._digCallback),this._rooms.push(e),e}return null},r.Map.Uniform.prototype._generateCorridors=function(){for(var t=0;t<this._corridorAttempts;){t++,this._corridors=[],this._map=this._fillMap(1);for(var e=0;e<this._rooms.length;e++){var i=this._rooms[e];i.clearDoors(),i.create(this._digCallback)}for(this._unconnected=this._rooms.slice().randomize(),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){var r=this._connected.random(),o=this._closestRoom(this._unconnected,r),n=this._closestRoom(this._connected,o);if(!this._connectRooms(o,n))break;if(!this._unconnected.length)return!0}}return!1},r.Map.Uniform.prototype._closestRoom=function(t,e){for(var i=1/0,r=e.getCenter(),o=null,n=0;n<t.length;n++){var s=t[n],a=s.getCenter(),h=a[0]-r[0],l=a[1]-r[1],c=h*h+l*l;c<i&&(i=c,o=s)}return o},r.Map.Uniform.prototype._connectRooms=function(t,e){var i=t.getCenter(),r=e.getCenter(),o=r[0]-i[0],n=r[1]-i[1];if(Math.abs(o)<Math.abs(n))var s=n>0?2:0,a=(s+2)%4,h=e.getLeft(),l=e.getRight(),c=0;else var s=o>0?1:3,a=(s+2)%4,h=e.getTop(),l=e.getBottom(),c=1;var u=this._placeInWall(t,s);if(!u)return!1;if(u[c]>=h&&u[c]<=l){var p=u.slice(),f=null;switch(a){case 0:f=e.getTop()-1;break;case 1:f=e.getRight()+1;break;case 2:f=e.getBottom()+1;break;case 3:f=e.getLeft()-1}p[(c+1)%2]=f,this._digLine([u,p])}else if(u[c]<h-1||u[c]>l+1){var _=u[c]-r[c];switch(a){case 0:case 1:var d=_<0?3:1;break;case 2:case 3:var d=_<0?1:3}a=(a+d)%4;var p=this._placeInWall(e,a);if(!p)return!1;var y=[0,0];y[c]=u[c];var g=(c+1)%2;y[g]=p[g],this._digLine([u,y,p])}else{var g=(c+1)%2,p=this._placeInWall(e,a);if(!p)return!1;var y=Math.round((p[g]+u[g])/2),v=[0,0],m=[0,0];v[c]=u[c],v[g]=y,m[c]=p[c],m[g]=y,this._digLine([u,v,m,p])}t.addDoor(u[0],u[1]),e.addDoor(p[0],p[1]);var c=this._unconnected.indexOf(t);-1!=c&&(this._unconnected.splice(c,1),this._connected.push(t));var c=this._unconnected.indexOf(e);return-1!=c&&(this._unconnected.splice(c,1),this._connected.push(e)),!0},r.Map.Uniform.prototype._placeInWall=function(t,e){var i=[0,0],r=[0,0],o=0;switch(e){case 0:r=[1,0],i=[t.getLeft(),t.getTop()-1],o=t.getRight()-t.getLeft()+1;break;case 1:r=[0,1],i=[t.getRight()+1,t.getTop()],o=t.getBottom()-t.getTop()+1;break;case 2:r=[1,0],i=[t.getLeft(),t.getBottom()+1],o=t.getRight()-t.getLeft()+1;break;case 3:r=[0,1],i=[t.getLeft()-1,t.getTop()],o=t.getBottom()-t.getTop()+1}for(var n=[],s=-2,a=0;a<o;a++){var h=i[0]+a*r[0],l=i[1]+a*r[1];n.push(null);1==this._map[h][l]?s!=a-1&&(n[a]=[h,l]):(s=a,a&&(n[a-1]=null))}for(var a=n.length-1;a>=0;a--)n[a]||n.splice(a,1);return n.length?n.random():null},r.Map.Uniform.prototype._digLine=function(t){for(var e=1;e<t.length;e++){var i=t[e-1],o=t[e],n=new r.Map.Feature.Corridor(i[0],i[1],o[0],o[1]);n.create(this._digCallback),this._corridors.push(n)}},r.Map.Uniform.prototype._digCallback=function(t,e,i){this._map[t][e]=i,0==i&&this._dug++},r.Map.Uniform.prototype._isWallCallback=function(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]},r.Map.Uniform.prototype._canBeDugCallback=function(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]},r.Map.Rogue=function(t,e,i){r.Map.call(this,t,e),this._options={cellWidth:3,cellHeight:3};for(var o in i)this._options[o]=i[o];this._options.hasOwnProperty("roomWidth")||(this._options.roomWidth=this._calculateRoomSize(this._width,this._options.cellWidth)),this._options.hasOwnProperty("roomHeight")||(this._options.roomHeight=this._calculateRoomSize(this._height,this._options.cellHeight))},r.Map.Rogue.extend(r.Map),r.Map.Rogue.prototype.create=function(t){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),t)for(var e=0;e<this._width;e++)for(var i=0;i<this._height;i++)t(e,i,this.map[e][i]);return this},r.Map.Rogue.prototype._calculateRoomSize=function(t,e){var i=Math.floor(t/e*.8),r=Math.floor(t/e*.25);return r<2&&(r=2),i<2&&(i=2),[r,i]},r.Map.Rogue.prototype._initRooms=function(){for(var t=0;t<this._options.cellWidth;t++){this.rooms.push([]);for(var e=0;e<this._options.cellHeight;e++)this.rooms[t].push({x:0,y:0,width:0,height:0,connections:[],cellx:t,celly:e})}},r.Map.Rogue.prototype._connectRooms=function(){var t,e,i,o,n,s=r.RNG.getUniformInt(0,this._options.cellWidth-1),a=r.RNG.getUniformInt(0,this._options.cellHeight-1),h=!1;do{var l=[0,2,4,6];l=l.randomize();do{if(h=!1,t=l.pop(),e=s+r.DIRS[8][t][0],i=a+r.DIRS[8][t][1],!(e<0||e>=this._options.cellWidth)&&!(i<0||i>=this._options.cellHeight)){if(o=this.rooms[s][a],o.connections.length>0&&o.connections[0][0]==e&&o.connections[0][1]==i)break;n=this.rooms[e][i],0==n.connections.length&&(n.connections.push([s,a]),this.connectedCells.push([e,i]),s=e,a=i,h=!0)}}while(l.length>0&&0==h)}while(l.length>0)},r.Map.Rogue.prototype._connectUnconnectedRooms=function(){var t=this._options.cellWidth,e=this._options.cellHeight;this.connectedCells=this.connectedCells.randomize();for(var i,o,n,s=0;s<this._options.cellWidth;s++)for(var a=0;a<this._options.cellHeight;a++)if(i=this.rooms[s][a],0==i.connections.length){var h=[0,2,4,6];h=h.randomize();var n=!1;do{var l=h.pop(),c=s+r.DIRS[8][l][0],u=a+r.DIRS[8][l][1];if(!(c<0||c>=t||u<0||u>=e)){if(o=this.rooms[c][u],n=!0,0==o.connections.length)break;for(var p=0;p<o.connections.length;p++)if(o.connections[p][0]==s&&o.connections[p][1]==a){n=!1;break}if(n)break}}while(h.length);n?i.connections.push([o.cellx,o.celly]):console.log("-- Unable to connect room.")}},r.Map.Rogue.prototype._createRandomRoomConnections=function(t){},r.Map.Rogue.prototype._createRooms=function(){for(var t,e,i,o,n,s=this._width,a=this._height,h=this._options.cellWidth,l=this._options.cellHeight,c=Math.floor(this._width/h),u=Math.floor(this._height/l),p=this._options.roomWidth,f=this._options.roomHeight,_=0;_<h;_++)for(var d=0;d<l;d++){if(i=c*_,o=u*d,0==i&&(i=1),0==o&&(o=1),t=r.RNG.getUniformInt(p[0],p[1]),e=r.RNG.getUniformInt(f[0],f[1]),d>0)for(n=this.rooms[_][d-1];o-(n.y+n.height)<3;)o++;if(_>0)for(n=this.rooms[_-1][d];i-(n.x+n.width)<3;)i++;for(var y=Math.round(r.RNG.getUniformInt(0,c-t)/2),g=Math.round(r.RNG.getUniformInt(0,u-e)/2);i+y+t>=s;)y?y--:t--;for(;o+g+e>=a;)g?g--:e--;i+=y,o+=g,this.rooms[_][d].x=i,this.rooms[_][d].y=o,this.rooms[_][d].width=t,this.rooms[_][d].height=e;for(var v=i;v<i+t;v++)for(var m=o;m<o+e;m++)this.map[v][m]=0}},r.Map.Rogue.prototype._getWallPosition=function(t,e){var i,o,n;return 1==e||3==e?(i=r.RNG.getUniformInt(t.x+1,t.x+t.width-2),1==e?(o=t.y-2,n=o+1):(o=t.y+t.height+1,n=o-1),this.map[i][n]=0):2!=e&&4!=e||(o=r.RNG.getUniformInt(t.y+1,t.y+t.height-2),2==e?(i=t.x+t.width+1,n=i-1):(i=t.x-2,n=i+1),this.map[n][o]=0),[i,o]},r.Map.Rogue.prototype._drawCorridore=function(t,e){var i,o,n,s,a=e[0]-t[0],h=e[1]-t[1],l=t[0],c=t[1],u=[],p=Math.abs(a),f=Math.abs(h),_=r.RNG.getUniform(),d=_,y=1-_;for(o=a>0?2:6,n=h>0?4:0,p<f?(i=Math.ceil(f*d),u.push([n,i]),u.push([o,p]),i=Math.floor(f*y),u.push([n,i])):(i=Math.ceil(p*d),u.push([o,i]),u.push([n,f]),i=Math.floor(p*y),u.push([o,i])),this.map[l][c]=0;u.length>0;)for(s=u.pop();s[1]>0;)l+=r.DIRS[8][s[0]][0],c+=r.DIRS[8][s[0]][1],this.map[l][c]=0,s[1]=s[1]-1},r.Map.Rogue.prototype._createCorridors=function(){for(var t,e,i,r,o,n=this._options.cellWidth,s=this._options.cellHeight,a=0;a<n;a++)for(var h=0;h<s;h++){t=this.rooms[a][h];for(var l=0;l<t.connections.length;l++)e=t.connections[l],i=this.rooms[e[0]][e[1]],i.cellx>t.cellx?(r=2,o=4):i.cellx<t.cellx?(r=4,o=2):i.celly>t.celly?(r=3,o=1):i.celly<t.celly&&(r=1,o=3),this._drawCorridore(this._getWallPosition(t,r),this._getWallPosition(i,o))}},r.Map.Feature=function(){},r.Map.Feature.prototype.isValid=function(t){},r.Map.Feature.prototype.create=function(t){},r.Map.Feature.prototype.debug=function(){},r.Map.Feature.createRandomAt=function(t,e,i,r,o){},r.Map.Feature.Room=function(t,e,i,r,o,n){this._x1=t,this._y1=e,this._x2=i,this._y2=r,this._doors={},arguments.length>4&&this.addDoor(o,n)},r.Map.Feature.Room.extend(r.Map.Feature),r.Map.Feature.Room.createRandomAt=function(t,e,i,o,n){var s=n.roomWidth[0],a=n.roomWidth[1],h=r.RNG.getUniformInt(s,a),s=n.roomHeight[0],a=n.roomHeight[1],l=r.RNG.getUniformInt(s,a);if(1==i){var c=e-Math.floor(r.RNG.getUniform()*l);return new this(t+1,c,t+h,c+l-1,t,e)}if(-1==i){var c=e-Math.floor(r.RNG.getUniform()*l);return new this(t-h,c,t-1,c+l-1,t,e)}if(1==o){var u=t-Math.floor(r.RNG.getUniform()*h);return new this(u,e+1,u+h-1,e+l,t,e)}if(-1==o){var u=t-Math.floor(r.RNG.getUniform()*h);return new this(u,e-l,u+h-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")},r.Map.Feature.Room.createRandomCenter=function(t,e,i){var o=i.roomWidth[0],n=i.roomWidth[1],s=r.RNG.getUniformInt(o,n),o=i.roomHeight[0],n=i.roomHeight[1],a=r.RNG.getUniformInt(o,n),h=t-Math.floor(r.RNG.getUniform()*s),l=e-Math.floor(r.RNG.getUniform()*a);return new this(h,l,h+s-1,l+a-1)},r.Map.Feature.Room.createRandom=function(t,e,i){var o=i.roomWidth[0],n=i.roomWidth[1],s=r.RNG.getUniformInt(o,n),o=i.roomHeight[0],n=i.roomHeight[1],a=r.RNG.getUniformInt(o,n),h=t-s-1,l=e-a-1,c=1+Math.floor(r.RNG.getUniform()*h),u=1+Math.floor(r.RNG.getUniform()*l);return new this(c,u,c+s-1,u+a-1)},r.Map.Feature.Room.prototype.addDoor=function(t,e){return this._doors[t+","+e]=1,this},r.Map.Feature.Room.prototype.getDoors=function(t){for(var e in this._doors){var i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this},r.Map.Feature.Room.prototype.clearDoors=function(){return this._doors={},this},r.Map.Feature.Room.prototype.addDoors=function(t){for(var e=this._x1-1,i=this._x2+1,r=this._y1-1,o=this._y2+1,n=e;n<=i;n++)for(var s=r;s<=o;s++)n!=e&&n!=i&&s!=r&&s!=o||t(n,s)||this.addDoor(n,s);return this},r.Map.Feature.Room.prototype.debug=function(){console.log("room",this._x1,this._y1,this._x2,this._y2)},r.Map.Feature.Room.prototype.isValid=function(t,e){for(var i=this._x1-1,r=this._x2+1,o=this._y1-1,n=this._y2+1,s=i;s<=r;s++)for(var a=o;a<=n;a++)if(s==i||s==r||a==o||a==n){if(!t(s,a))return!1}else if(!e(s,a))return!1;return!0},r.Map.Feature.Room.prototype.create=function(t){for(var e=this._x1-1,i=this._x2+1,r=this._y1-1,o=this._y2+1,n=0,s=e;s<=i;s++)for(var a=r;a<=o;a++)n=s+","+a in this._doors?2:s==e||s==i||a==r||a==o?1:0,t(s,a,n)},r.Map.Feature.Room.prototype.getCenter=function(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]},r.Map.Feature.Room.prototype.getLeft=function(){return this._x1},r.Map.Feature.Room.prototype.getRight=function(){return this._x2},r.Map.Feature.Room.prototype.getTop=function(){return this._y1},r.Map.Feature.Room.prototype.getBottom=function(){return this._y2};r.Map.Feature.Corridor=function(t,e,i,r){this._startX=t,this._startY=e,this._endX=i,this._endY=r,this._endsWithAWall=!0},r.Map.Feature.Corridor.extend(r.Map.Feature),r.Map.Feature.Corridor.createRandomAt=function(t,e,i,o,n){var s=n.corridorLength[0],a=n.corridorLength[1],h=r.RNG.getUniformInt(s,a);return new this(t,e,t+i*h,e+o*h)},r.Map.Feature.Corridor.prototype.debug=function(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)},r.Map.Feature.Corridor.prototype.isValid=function(t,e){var i=this._startX,r=this._startY,o=this._endX-i,n=this._endY-r,s=1+Math.max(Math.abs(o),Math.abs(n));o&&(o/=Math.abs(o)),n&&(n/=Math.abs(n));for(var a=n,h=-o,l=!0,c=0;c<s;c++){var u=i+c*o,p=r+c*n;if(e(u,p)||(l=!1),t(u+a,p+h)||(l=!1),t(u-a,p-h)||(l=!1),!l){s=c,this._endX=u-o,this._endY=p-n;break}}if(0==s)return!1;if(1==s&&t(this._endX+o,this._endY+n))return!1;var f=!t(this._endX+o+a,this._endY+n+h),_=!t(this._endX+o-a,this._endY+n-h);return this._endsWithAWall=t(this._endX+o,this._endY+n),!f&&!_||!this._endsWithAWall},r.Map.Feature.Corridor.prototype.create=function(t){var e=this._startX,i=this._startY,r=this._endX-e,o=this._endY-i,n=1+Math.max(Math.abs(r),Math.abs(o));r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));for(var s=0;s<n;s++){t(e+s*r,i+s*o,0)}return!0},r.Map.Feature.Corridor.prototype.createPriorityWalls=function(t){if(this._endsWithAWall){var e=this._startX,i=this._startY,r=this._endX-e,o=this._endY-i;r&&(r/=Math.abs(r)),o&&(o/=Math.abs(o));var n=o,s=-r;t(this._endX+r,this._endY+o),t(this._endX+n,this._endY+s),t(this._endX-n,this._endY-s)}},r.Noise=function(){},r.Noise.prototype.get=function(t,e){},r.Noise.Simplex=function(t){r.Noise.call(this),this._F2=.5*(Math.sqrt(3)-1),this._G2=(3-Math.sqrt(3))/6,this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];for(var e=[],i=t||256,o=0;o<i;o++)e.push(o);e=e.randomize(),this._perms=[],this._indexes=[];for(var o=0;o<2*i;o++)this._perms.push(e[o%i]),this._indexes.push(this._perms[o]%this._gradients.length)},r.Noise.Simplex.extend(r.Noise),r.Noise.Simplex.prototype.get=function(t,e){var i,r,o,n=this._perms,s=this._indexes,a=n.length/2,h=this._G2,l=0,c=0,u=0,p=(t+e)*this._F2,f=Math.floor(t+p),_=Math.floor(e+p),d=(f+_)*h,y=f-d,g=_-d,v=t-y,m=e-g;v>m?(r=1,o=0):(r=0,o=1);var b=v-r+h,w=m-o+h,M=v-1+2*h,x=m-1+2*h,T=f.mod(a),k=_.mod(a),S=.5-v*v-m*m;if(S>=0){S*=S,i=s[T+n[k]];var R=this._gradients[i];l=S*S*(R[0]*v+R[1]*m)}var V=.5-b*b-w*w;if(V>=0){V*=V,i=s[T+r+n[k+o]];var R=this._gradients[i];c=V*V*(R[0]*b+R[1]*w)}var C=.5-M*M-x*x;if(C>=0){C*=C,i=s[T+1+n[k+1]];var R=this._gradients[i];u=C*C*(R[0]*M+R[1]*x)}return 70*(l+c+u)},r.FOV=function(t,e){this._lightPasses=t,this._options={topology:8};for(var i in e)this._options[i]=e[i]},r.FOV.prototype.compute=function(t,e,i,r){},r.FOV.prototype._getCircle=function(t,e,i){var o,n,s,a=[];switch(this._options.topology){case 4:n=1,s=[0,1],o=[r.DIRS[8][7],r.DIRS[8][1],r.DIRS[8][3],r.DIRS[8][5]];break;case 6:o=r.DIRS[6],n=1,s=[-1,1];break;case 8:o=r.DIRS[4],n=2,s=[-1,1]}for(var h=t+s[0]*i,l=e+s[1]*i,c=0;c<o.length;c++)for(var u=0;u<i*n;u++)a.push([h,l]),h+=o[c][0],l+=o[c][1];return a},r.FOV.DiscreteShadowcasting=function(t,e){r.FOV.call(this,t,e)},r.FOV.DiscreteShadowcasting.extend(r.FOV),r.FOV.DiscreteShadowcasting.prototype.compute=function(t,e,i,r){this._coords,this._map;if(r(t,e,0,1),this._lightPasses(t,e))for(var o,n,s,a,h,l=[],c=1;c<=i;c++)for(var u=this._getCircle(t,e,c),p=360/u.length,f=0;f<u.length;f++)if(s=u[f][0],a=u[f][1],o=p*(f-.5),n=o+p,h=!this._lightPasses(s,a),this._visibleCoords(Math.floor(o),Math.ceil(n),h,l)&&r(s,a,c,1),2==l.length&&0==l[0]&&360==l[1])return},r.FOV.DiscreteShadowcasting.prototype._visibleCoords=function(t,e,i,r){if(t<0){var o=arguments.callee(0,e,i,r),n=arguments.callee(360+t,360,i,r);return o||n}for(var s=0;s<r.length&&r[s]<t;)s++;if(s==r.length)return i&&r.push(t,e),!0;var a=0;if(s%2){for(;s<r.length&&r[s]<e;)s++,a++;return 0!=a&&(i&&(a%2?r.splice(s-a,a,e):r.splice(s-a,a)),!0)}for(;s<r.length&&r[s]<e;)s++,a++;return(t!=r[s-a]||1!=a)&&(i&&(a%2?r.splice(s-a,a,t):r.splice(s-a,a,t,e)),!0)},r.FOV.PreciseShadowcasting=function(t,e){r.FOV.call(this,t,e)},r.FOV.PreciseShadowcasting.extend(r.FOV),r.FOV.PreciseShadowcasting.prototype.compute=function(t,e,i,r){if(r(t,e,0,1),this._lightPasses(t,e))for(var o,n,s,a,h,l,c=[],u=1;u<=i;u++)for(var p=this._getCircle(t,e,u),f=p.length,_=0;_<f;_++)if(o=p[_][0],n=p[_][1],a=[_?2*_-1:2*f-1,2*f],h=[2*_+1,2*f],s=!this._lightPasses(o,n),l=this._checkVisibility(a,h,s,c),l&&r(o,n,u,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return},r.FOV.PreciseShadowcasting.prototype._checkVisibility=function(t,e,i,r){if(t[0]>e[0]){return(this._checkVisibility(t,[t[1],t[1]],i,r)+this._checkVisibility([0,1],e,i,r))/2}for(var o=0,n=!1;o<r.length;){var s=r[o],a=s[0]*t[1]-t[0]*s[1];if(a>=0){0!=a||o%2||(n=!0);break}o++}for(var h=r.length,l=!1;h--;){var s=r[h],a=e[0]*s[1]-s[0]*e[1];if(a>=0){0==a&&h%2&&(l=!0);break}}var c=!0;if(o==h&&(n||l)?c=!1:n&&l&&o+1==h&&h%2?c=!1:o>h&&o%2&&(c=!1),!c)return 0;var u,p,f=h-o+1;if(f%2)if(o%2){var p=r[o];u=(e[0]*p[1]-p[0]*e[1])/(p[1]*e[1]),i&&r.splice(o,f,e)}else{var p=r[h];u=(p[0]*t[1]-t[0]*p[1])/(t[1]*p[1]),i&&r.splice(o,f,t)}else{if(!(o%2))return i&&r.splice(o,f,t,e),1;var _=r[o],d=r[h];u=(d[0]*_[1]-_[0]*d[1])/(_[1]*d[1]),i&&r.splice(o,f)}return u/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))},r.FOV.RecursiveShadowcasting=function(t,e){r.FOV.call(this,t,e)},r.FOV.RecursiveShadowcasting.extend(r.FOV),r.FOV.RecursiveShadowcasting.OCTANTS=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]],r.FOV.RecursiveShadowcasting.prototype.compute=function(t,e,i,o){o(t,e,0,1);for(var n=0;n<r.FOV.RecursiveShadowcasting.OCTANTS.length;n++)this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[n],i,o)},r.FOV.RecursiveShadowcasting.prototype.compute180=function(t,e,i,o,n){n(t,e,0,1);var s=(o-1+8)%8,a=(o-2+8)%8,h=(o+1+8)%8;this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[a],i,n),this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[s],i,n),this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[o],i,n),this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[h],i,n)},r.FOV.RecursiveShadowcasting.prototype.compute90=function(t,e,i,o,n){n(t,e,0,1);var s=(o-1+8)%8;this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[o],i,n),this._renderOctant(t,e,r.FOV.RecursiveShadowcasting.OCTANTS[s],i,n)},r.FOV.RecursiveShadowcasting.prototype._renderOctant=function(t,e,i,r,o){this._castVisibility(t,e,1,1,0,r+1,i[0],i[1],i[2],i[3],o)},r.FOV.RecursiveShadowcasting.prototype._castVisibility=function(t,e,i,r,o,n,s,a,h,l,c){if(!(r<o))for(var u=i;u<=n;u++){for(var p=-u-1,f=-u,_=!1,d=0;p<=0;){p+=1;var y=t+p*s+f*a,g=e+p*h+f*l,v=(p-.5)/(f+.5),m=(p+.5)/(f-.5);if(!(m>r)){if(v<o)break;if(p*p+f*f<n*n&&c(y,g,u,1),_){if(!this._lightPasses(y,g)){d=m;continue}_=!1,r=d}else!this._lightPasses(y,g)&&u<n&&(_=!0,this._castVisibility(t,e,u+1,r,v,n,s,a,h,l,c),d=m)}}if(_)break}},r.Color={fromString:function(t){var e,i;if(t in this._cache)e=this._cache[t];else{if("#"==t.charAt(0)){var r=t.match(/[0-9a-f]/gi).map(function(t){return parseInt(t,16)});if(3==r.length)e=r.map(function(t){return 17*t});else{for(var o=0;o<3;o++)r[o+1]+=16*r[o],r.splice(o,1);e=r}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(function(t){return parseInt(t)}):[0,0,0];this._cache[t]=e}return e.slice()},add:function(t,e){for(var i=t.slice(),r=0;r<3;r++)for(var o=1;o<arguments.length;o++)i[r]+=arguments[o][r];return i},add_:function(t,e){for(var i=0;i<3;i++)for(var r=1;r<arguments.length;r++)t[i]+=arguments[r][i];return t},multiply:function(t,e){for(var i=t.slice(),r=0;r<3;r++){for(var o=1;o<arguments.length;o++)i[r]*=arguments[o][r]/255;i[r]=Math.round(i[r])}return i},multiply_:function(t,e){for(var i=0;i<3;i++){for(var r=1;r<arguments.length;r++)t[i]*=arguments[r][i]/255;t[i]=Math.round(t[i])}return t},interpolate:function(t,e,i){arguments.length<3&&(i=.5);for(var r=t.slice(),o=0;o<3;o++)r[o]=Math.round(r[o]+i*(e[o]-t[o]));return r},interpolateHSL:function(t,e,i){arguments.length<3&&(i=.5);for(var r=this.rgb2hsl(t),o=this.rgb2hsl(e),n=0;n<3;n++)r[n]+=i*(o[n]-r[n]);return this.hsl2rgb(r)},randomize:function(t,e){e instanceof Array||(e=Math.round(r.RNG.getNormal(0,e)));for(var i=t.slice(),o=0;o<3;o++)i[o]+=e instanceof Array?Math.round(r.RNG.getNormal(0,e[o])):e;return i},rgb2hsl:function(t){var e,i,r=t[0]/255,o=t[1]/255,n=t[2]/255,s=Math.max(r,o,n),a=Math.min(r,o,n),h=(s+a)/2;if(s==a)e=i=0;else{var l=s-a;switch(i=h>.5?l/(2-s-a):l/(s+a),s){case r:e=(o-n)/l+(o<n?6:0);break;case o:e=(n-r)/l+2;break;case n:e=(r-o)/l+4}e/=6}return[e,i,h]},hsl2rgb:function(t){var e=t[2];if(0==t[1])return e=Math.round(255*e),[e,e,e];var i=function(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t},r=t[1],o=e<.5?e*(1+r):e+r-e*r,n=2*e-o,s=i(n,o,t[0]+1/3),a=i(n,o,t[0]),h=i(n,o,t[0]-1/3);return[Math.round(255*s),Math.round(255*a),Math.round(255*h)]},toRGB:function(t){return"rgb("+this._clamp(t[0])+","+this._clamp(t[1])+","+this._clamp(t[2])+")"},toHex:function(t){for(var e=[],i=0;i<3;i++)e.push(this._clamp(t[i]).toString(16).lpad("0",2));return"#"+e.join("")},_clamp:function(t){return t<0?0:t>255?255:t},_cache:{black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]}},r.Lighting=function(t,e){this._reflectivityCallback=t,this._options={passes:1,emissionThreshold:100,range:10},this._fov=null,this._lights={},this._reflectivityCache={},this._fovCache={},this.setOptions(e)},r.Lighting.prototype.setOptions=function(t){for(var e in t)this._options[e]=t[e];return t&&t.range&&this.reset(),this},r.Lighting.prototype.setFOV=function(t){return this._fov=t,this._fovCache={},this},r.Lighting.prototype.setLight=function(t,e,i){var o=t+","+e;return i?this._lights[o]="string"==typeof i?r.Color.fromString(i):i:delete this._lights[o],this},r.Lighting.prototype.clearLights=function(){this._lights={}},r.Lighting.prototype.reset=function(){return this._reflectivityCache={},this._fovCache={},this},r.Lighting.prototype.compute=function(t){var e={},i={},o={};for(var n in this._lights){var s=this._lights[n];i[n]=[0,0,0],r.Color.add_(i[n],s)}for(var a=0;a<this._options.passes;a++)this._emitLight(i,o,e),a+1!=this._options.passes&&(i=this._computeEmitters(o,e));for(var h in o){var l=h.split(",");t(parseInt(l[0]),parseInt(l[1]),o[h])}return this},r.Lighting.prototype._emitLight=function(t,e,i){for(var r in t){var o=r.split(","),n=parseInt(o[0]),s=parseInt(o[1]);this._emitLightFromCell(n,s,t[r],e),i[r]=1}return this},r.Lighting.prototype._computeEmitters=function(t,e){var i={};for(var r in t)if(!(r in e)){var o=t[r];if(r in this._reflectivityCache)var n=this._reflectivityCache[r];else{var s=r.split(","),a=parseInt(s[0]),h=parseInt(s[1]),n=this._reflectivityCallback(a,h);this._reflectivityCache[r]=n}if(0!=n){for(var l=[],c=0,u=0;u<3;u++){var p=Math.round(o[u]*n);l[u]=p,c+=p}c>this._options.emissionThreshold&&(i[r]=l)}}return i},r.Lighting.prototype._emitLightFromCell=function(t,e,i,r){var o=t+","+e;if(o in this._fovCache)var n=this._fovCache[o];else var n=this._updateFOV(t,e);for(var s in n){var a=n[s];if(s in r)var h=r[s];else{var h=[0,0,0];r[s]=h}for(var l=0;l<3;l++)h[l]+=Math.round(i[l]*a)}return this},r.Lighting.prototype._updateFOV=function(t,e){var i=t+","+e,r={};this._fovCache[i]=r;var o=this._options.range,n=function(t,e,i,n){var s=t+","+e,a=n*(1-i/o);0!=a&&(r[s]=a)};return this._fov.compute(t,e,o,n.bind(this)),r},r.Path=function(t,e,i,o){this._toX=t,this._toY=e,this._fromX=null,this._fromY=null,this._passableCallback=i,this._options={topology:8};for(var n in o)this._options[n]=o[n];this._dirs=r.DIRS[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])},r.Path.prototype.compute=function(t,e,i){},r.Path.prototype._getNeighbors=function(t,e){for(var i=[],r=0;r<this._dirs.length;r++){var o=this._dirs[r],n=t+o[0],s=e+o[1];this._passableCallback(n,s)&&i.push([n,s])}return i},r.Path.Dijkstra=function(t,e,i,o){r.Path.call(this,t,e,i,o),this._computed={},this._todo=[],this._add(t,e,null)},r.Path.Dijkstra.extend(r.Path),r.Path.Dijkstra.prototype.compute=function(t,e,i){var r=t+","+e;if(r in this._computed||this._compute(t,e),r in this._computed)for(var o=this._computed[r];o;)i(o.x,o.y),o=o.prev},r.Path.Dijkstra.prototype._compute=function(t,e){for(;this._todo.length;){var i=this._todo.shift();if(i.x==t&&i.y==e)return;for(var r=this._getNeighbors(i.x,i.y),o=0;o<r.length;o++){var n=r[o],s=n[0],a=n[1];s+","+a in this._computed||this._add(s,a,i)}}},r.Path.Dijkstra.prototype._add=function(t,e,i){var r={x:t,y:e,prev:i};this._computed[t+","+e]=r,this._todo.push(r)},r.Path.AStar=function(t,e,i,o){r.Path.call(this,t,e,i,o),this._todo=[],this._done={},this._fromX=null,this._fromY=null},r.Path.AStar.extend(r.Path),r.Path.AStar.prototype.compute=function(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){var r=this._todo.shift();if(r.x==t&&r.y==e)break;for(var o=this._getNeighbors(r.x,r.y),n=0;n<o.length;n++){var s=o[n],a=s[0],h=s[1];a+","+h in this._done||this._add(a,h,r)}}var r=this._done[t+","+e];if(r)for(;r;)i(r.x,r.y),r=r.prev},r.Path.AStar.prototype._add=function(t,e,i){var r={x:t,y:e,prev:i,g:i?i.g+1:0,h:this._distance(t,e)};this._done[t+","+e]=r;for(var o=r.g+r.h,n=0;n<this._todo.length;n++){var s=this._todo[n];if(o<s.g+s.h)return void this._todo.splice(n,0,r)}this._todo.push(r)},r.Path.AStar.prototype._distance=function(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:var i=Math.abs(t-this._fromX),r=Math.abs(e-this._fromY);return r+Math.max(0,(i-r)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}throw new Error("Illegal topology")},r.Display.Term=function(t){r.Display.Backend.call(this,t),this._cx=-1,this._cy=-1,this._lastColor="",this._options={},this._ox=0,this._oy=0,this._termcolor={}},r.Display.Term.extend(r.Display.Backend),r.Display.Term.prototype.compute=function(t){this._options=t,this._ox=Math.floor((i.stdout.columns-t.width)/2),this._oy=Math.floor((i.stdout.rows-t.height)/2),this._termcolor=new(r.Display.Term[t.termColor.capitalize()])(this._context),this._context._termcolor=this._termcolor},r.Display.Term.prototype.draw=function(t,e){var r=t[0],o=t[1],n=t[2],s=t[3],a=t[4],h=this._ox+r,l=this._oy+o;if(!(h<0||h>=i.stdout.columns)&&!(l<0||l>=i.stdout.rows)&&(h===this._cx&&l===this._cy||(i.stdout.write(this._termcolor.positionToAnsi(h,l)),this._cx=h,this._cy=l),e&&(n||(n=" ")),n)){var c=this._termcolor.colorToAnsi(s,a);c!==this._lastColor&&(i.stdout.write(c),this._lastColor=c);var u=[].concat(n);i.stdout.write(u[0]),this._cx++,this._cx>=i.stdout.columns&&(this._cx=0,this._cy++)}},r.Display.Term.prototype.computeSize=function(t,e){return[i.stdout.columns,i.stdout.rows]},r.Display.Term.prototype.computeFontSize=function(t,e){return 12},r.Display.Term.prototype.eventToPosition=function(t,e){return[t,e]},r.Display.Term.Color=function(t){this._context=t},r.Display.Term.Color.prototype.clearToAnsi=function(t){},r.Display.Term.Color.prototype.colorToAnsi=function(t,e){},r.Display.Term.Color.prototype.positionToAnsi=function(t,e){},r.Display.Term.Xterm=function(t){r.Display.Term.Color.call(this,t)},r.Display.Term.Xterm.extend(r.Display.Term.Color),r.Display.Term.Xterm.prototype.clearToAnsi=function(t){return"[0;48;5;"+this._termcolor(t)+"m[2J"},r.Display.Term.Xterm.prototype.colorToAnsi=function(t,e){return"[0;38;5;"+this._termcolor(t)+";48;5;"+this._termcolor(e)+"m"},r.Display.Term.Xterm.prototype.positionToAnsi=function(t,e){return"["+(e+1)+";"+(t+1)+"H"},r.Display.Term.Xterm.prototype._termcolor=function(t){var e=r.Color.fromString(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16};for(var o in r)e[o]=r[o]}).call(e,i(6),i(14))},function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==typeof e&&"function"!==typeof e?t:e}function n(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var s=i(2),a=i(0),h=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),l=function(t){function e(t){r(this,e);var i=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.setPosition=function(t,e){return e!==this._level&&e===a.a.level&&a.a.scheduler.add(this,!0),s.a.prototype.setPosition.call(this,t,e)},i._speed=100,i._hp=10,i}return n(e,t),h(e,[{key:"getSpeed",value:function(){return this._speed}},{key:"damage",value:function(t){this._hp-=t,this._hp<=0&&this.die()}},{key:"act",value:function(){}},{key:"die",value:function(){a.a.scheduler.remove(this)}}]),e}(s.a);e.a=l},function(t,e,i){"use strict";function r(){}function o(t){try{return t.then}catch(t){return g=t,v}}function n(t,e){try{return t(e)}catch(t){return g=t,v}}function s(t,e,i){try{t(e,i)}catch(t){return g=t,v}}function a(t){if("object"!==typeof this)throw new TypeError("Promises must be constructed via new");if("function"!==typeof t)throw new TypeError("not a function");this._45=0,this._81=0,this._65=null,this._54=null,t!==r&&d(t,this)}function h(t,e,i){return new t.constructor(function(o,n){var s=new a(r);s.then(o,n),l(t,new _(e,i,s))})}function l(t,e){for(;3===t._81;)t=t._65;if(a._10&&a._10(t),0===t._81)return 0===t._45?(t._45=1,void(t._54=e)):1===t._45?(t._45=2,void(t._54=[t._54,e])):void t._54.push(e);c(t,e)}function c(t,e){y(function(){var i=1===t._81?e.onFulfilled:e.onRejected;if(null===i)return void(1===t._81?u(e.promise,t._65):p(e.promise,t._65));var r=n(i,t._65);r===v?p(e.promise,g):u(e.promise,r)})}function u(t,e){if(e===t)return p(t,new TypeError("A promise cannot be resolved with itself."));if(e&&("object"===typeof e||"function"===typeof e)){var i=o(e);if(i===v)return p(t,g);if(i===t.then&&e instanceof a)return t._81=3,t._65=e,void f(t);if("function"===typeof i)return void d(i.bind(e),t)}t._81=1,t._65=e,f(t)}function p(t,e){t._81=2,t._65=e,a._97&&a._97(t,e),f(t)}function f(t){if(1===t._45&&(l(t,t._54),t._54=null),2===t._45){for(var e=0;e<t._54.length;e++)l(t,t._54[e]);t._54=null}}function _(t,e,i){this.onFulfilled="function"===typeof t?t:null,this.onRejected="function"===typeof e?e:null,this.promise=i}function d(t,e){var i=!1,r=s(t,function(t){i||(i=!0,u(e,t))},function(t){i||(i=!0,p(e,t))});i||r!==v||(i=!0,p(e,g))}var y=i(9),g=null,v={};t.exports=a,a._10=null,a._97=null,a._61=r,a.prototype.then=function(t,e){if(this.constructor!==a)return h(this,t,e);var i=new a(r);return l(this,new _(t,e,i)),i}},function(t,e){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(t){"object"===typeof window&&(i=window)}t.exports=i},function(t,e,i){"use strict";"undefined"===typeof Promise&&(i(16).enable(),window.Promise=i(15)),i(17),Object.assign=i(13)},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=i(3),o=i.n(r),n=i(0);o.a.isSupported()?n.a.init():alert("The rot.js library isn't supported by your browser.")},function(t,e,i){"use strict";(function(e){function i(t){s.length||(n(),a=!0),s[s.length]=t}function r(){for(;h<s.length;){var t=h;if(h+=1,s[t].call(),h>l){for(var e=0,i=s.length-h;e<i;e++)s[e]=s[e+h];s.length-=h,h=0}}s.length=0,h=0,a=!1}function o(t){return function(){function e(){clearTimeout(i),clearInterval(r),t()}var i=setTimeout(e,0),r=setInterval(e,50)}}t.exports=i;var n,s=[],a=!1,h=0,l=1024,c="undefined"!==typeof e?e:self,u=c.MutationObserver||c.WebKitMutationObserver;n="function"===typeof u?function(t){var e=1,i=new u(t),r=document.createTextNode("");return i.observe(r,{characterData:!0}),function(){e=-e,r.data=e}}(r):o(r),i.requestFlush=n,i.makeRequestCallFromTimer=o}).call(e,i(6))},function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=i(2),n=i(0),s=i(1),a=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),h=function(){function t(){r(this,t),this._beings={},this._size=new s.a(80,25),this._map={},this._empty=new o.a({ch:".",fg:"#888",bg:null})}return a(t,[{key:"getSize",value:function(){return this._size}},{key:"setEntity",value:function(t,e){if(t.getLevel()===this){var i=t.getXY();delete this._beings[i],n.a.level===this&&n.a.draw(i)}t.setPosition(e,this),this._beings[e]=t,n.a.level===this&&(n.a.draw(e),n.a.textBuffer.write("An entity moves to "+e+"."))}},{key:"getEntityAt",value:function(t){return this._beings[t]||this._map[t]||this._empty}},{key:"getBeings",value:function(){return this._beings}}]),t}();e.a=h},function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function o(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!==typeof e&&"function"!==typeof e?t:e}function n(t,e){if("function"!==typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var s=i(3),a=i.n(s),h=i(4),l=i(0),c=i(1),u=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),p=function t(e,i,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var n=Object.getPrototypeOf(e);return null===n?void 0:t(n,i,r)}if("value"in o)return o.value;var s=o.get;if(void 0!==s)return s.call(r)},f=function(t){function e(){r(this,e);var t=o(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,{ch:"@",fg:"#fff"}));return t._handleKey=function(t){if(t in this._keys){l.a.textBuffer.clear();var e=this._keys[t];if(-1===e)return!0;var i=a.a.DIRS[8][e],r=this._xy.plus(new c.a(i[0],i[1]));return this._level.setEntity(this,r),!0}return!1},t._keys={},t._keys[a.a.VK_K]=0,t._keys[a.a.VK_UP]=0,t._keys[a.a.VK_NUMPAD8]=0,t._keys[a.a.VK_U]=1,t._keys[a.a.VK_NUMPAD9]=1,t._keys[a.a.VK_L]=2,t._keys[a.a.VK_RIGHT]=2,t._keys[a.a.VK_NUMPAD6]=2,t._keys[a.a.VK_N]=3,t._keys[a.a.VK_NUMPAD3]=3,t._keys[a.a.VK_J]=4,t._keys[a.a.VK_DOWN]=4,t._keys[a.a.VK_NUMPAD2]=4,t._keys[a.a.VK_B]=5,t._keys[a.a.VK_NUMPAD1]=5,t._keys[a.a.VK_H]=6,t._keys[a.a.VK_LEFT]=6,t._keys[a.a.VK_NUMPAD4]=6,t._keys[a.a.VK_Y]=7,t._keys[a.a.VK_NUMPAD7]=7,t._keys[a.a.VK_PERIOD]=-1,t._keys[a.a.VK_CLEAR]=-1,t._keys[a.a.VK_NUMPAD5]=-1,t}return n(e,t),u(e,[{key:"act",value:function(){l.a.textBuffer.write("It is your turn, press any relevant key."),l.a.textBuffer.flush(),l.a.engine.lock(),window.addEventListener("keydown",this)}},{key:"die",value:function(){p(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"die",this).call(this),l.a.over()}},{key:"handleEvent",value:function(t){t.keyCode;this._handleKey(t.keyCode)&&(window.removeEventListener("keydown",this),l.a.engine.unlock())}}]),e}(h.a);e.a=f},function(t,e,i){"use strict";function r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var o=i(1),n=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),s=function(){function t(){r(this,t),this._data=[],this._options={display:null,position:new o.a,size:new o.a}}return n(t,[{key:"configure",value:function(t){for(var e in t)this._options[e]=t[e]}},{key:"clear",value:function(){this._data=[]}},{key:"write",value:function(t){this._data.push(t)}},{key:"flush",value:function(){for(var t=this._options,e=t.display,i=t.position,r=t.size,o=0;o<r.x;o++)for(var n=0;n<r.y;n++)e.draw(i.x+o,i.y+n);var s=this._data.join(" ");e.drawText(i.x,i.y,s,r.x)}}]),t}();e.a=s},function(t,e,i){"use strict";function r(t){if(null===t||void 0===t)throw new TypeError("Object.assign cannot be called with null or undefined");return Object(t)}var o=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable;t.exports=function(){try{if(!Object.assign)return!1;var t=new String("abc");if(t[5]="de","5"===Object.getOwnPropertyNames(t)[0])return!1;for(var e={},i=0;i<10;i++)e["_"+String.fromCharCode(i)]=i;if("0123456789"!==Object.getOwnPropertyNames(e).map(function(t){return e[t]}).join(""))return!1;var r={};return"abcdefghijklmnopqrst".split("").forEach(function(t){r[t]=t}),"abcdefghijklmnopqrst"===Object.keys(Object.assign({},r)).join("")}catch(t){return!1}}()?Object.assign:function(t,e){for(var i,a,h=r(t),l=1;l<arguments.length;l++){i=Object(arguments[l]);for(var c in i)n.call(i,c)&&(h[c]=i[c]);if(o){a=o(i);for(var u=0;u<a.length;u++)s.call(i,a[u])&&(h[a[u]]=i[a[u]])}}return h}},function(t,e){function i(){throw new Error("setTimeout has not been defined")}function r(){throw new Error("clearTimeout has not been defined")}function o(t){if(c===setTimeout)return setTimeout(t,0);if((c===i||!c)&&setTimeout)return c=setTimeout,setTimeout(t,0);try{return c(t,0)}catch(e){try{return c.call(null,t,0)}catch(e){return c.call(this,t,0)}}}function n(t){if(u===clearTimeout)return clearTimeout(t);if((u===r||!u)&&clearTimeout)return u=clearTimeout,clearTimeout(t);try{return u(t)}catch(e){try{return u.call(null,t)}catch(e){return u.call(this,t)}}}function s(){d&&f&&(d=!1,f.length?_=f.concat(_):y=-1,_.length&&a())}function a(){if(!d){var t=o(s);d=!0;for(var e=_.length;e;){for(f=_,_=[];++y<e;)f&&f[y].run();y=-1,e=_.length}f=null,d=!1,n(t)}}function h(t,e){this.fun=t,this.array=e}function l(){}var c,u,p=t.exports={};!function(){try{c="function"===typeof setTimeout?setTimeout:i}catch(t){c=i}try{u="function"===typeof clearTimeout?clearTimeout:r}catch(t){u=r}}();var f,_=[],d=!1,y=-1;p.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)e[i-1]=arguments[i];_.push(new h(t,e)),1!==_.length||d||o(a)},h.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=l,p.addListener=l,p.once=l,p.off=l,p.removeListener=l,p.removeAllListeners=l,p.emit=l,p.prependListener=l,p.prependOnceListener=l,p.listeners=function(t){return[]},p.binding=function(t){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(t){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},function(t,e,i){"use strict";function r(t){var e=new o(o._61);return e._81=1,e._65=t,e}var o=i(5);t.exports=o;var n=r(!0),s=r(!1),a=r(null),h=r(void 0),l=r(0),c=r("");o.resolve=function(t){if(t instanceof o)return t;if(null===t)return a;if(void 0===t)return h;if(!0===t)return n;if(!1===t)return s;if(0===t)return l;if(""===t)return c;if("object"===typeof t||"function"===typeof t)try{var e=t.then;if("function"===typeof e)return new o(e.bind(t))}catch(t){return new o(function(e,i){i(t)})}return r(t)},o.all=function(t){var e=Array.prototype.slice.call(t);return new o(function(t,i){function r(s,a){if(a&&("object"===typeof a||"function"===typeof a)){if(a instanceof o&&a.then===o.prototype.then){for(;3===a._81;)a=a._65;return 1===a._81?r(s,a._65):(2===a._81&&i(a._65),void a.then(function(t){r(s,t)},i))}var h=a.then;if("function"===typeof h){return void new o(h.bind(a)).then(function(t){r(s,t)},i)}}e[s]=a,0===--n&&t(e)}if(0===e.length)return t([]);for(var n=e.length,s=0;s<e.length;s++)r(s,e[s])})},o.reject=function(t){return new o(function(e,i){i(t)})},o.race=function(t){return new o(function(e,i){t.forEach(function(t){o.resolve(t).then(e,i)})})},o.prototype.catch=function(t){return this.then(null,t)}},function(t,e,i){"use strict";function r(){l=!1,a._10=null,a._97=null}function o(t){function e(e){(t.allRejections||s(u[e].error,t.whitelist||h))&&(u[e].displayId=c++,t.onUnhandled?(u[e].logged=!0,t.onUnhandled(u[e].displayId,u[e].error)):(u[e].logged=!0,n(u[e].displayId,u[e].error)))}function i(e){u[e].logged&&(t.onHandled?t.onHandled(u[e].displayId,u[e].error):u[e].onUnhandled||(console.warn("Promise Rejection Handled (id: "+u[e].displayId+"):"),console.warn('  This means you can ignore any previous messages of the form "Possible Unhandled Promise Rejection" with id '+u[e].displayId+".")))}t=t||{},l&&r(),l=!0;var o=0,c=0,u={};a._10=function(t){2===t._81&&u[t._72]&&(u[t._72].logged?i(t._72):clearTimeout(u[t._72].timeout),delete u[t._72])},a._97=function(t,i){0===t._45&&(t._72=o++,u[t._72]={displayId:null,error:i,timeout:setTimeout(e.bind(null,t._72),s(i,h)?100:2e3),logged:!1})}}function n(t,e){console.warn("Possible Unhandled Promise Rejection (id: "+t+"):"),((e&&(e.stack||e))+"").split("\n").forEach(function(t){console.warn("  "+t)})}function s(t,e){return e.some(function(e){return t instanceof e})}var a=i(5),h=[ReferenceError,TypeError,RangeError],l=!1;e.disable=r,e.enable=o},function(t,e){!function(t){"use strict";function e(t){if("string"!==typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function i(t){return"string"!==typeof t&&(t=String(t)),t}function r(t){var e={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return g.iterable&&(e[Symbol.iterator]=function(){return e}),e}function o(t){this.map={},t instanceof o?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function n(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function s(t){return new Promise(function(e,i){t.onload=function(){e(t.result)},t.onerror=function(){i(t.error)}})}function a(t){var e=new FileReader,i=s(e);return e.readAsArrayBuffer(t),i}function h(t){var e=new FileReader,i=s(e);return e.readAsText(t),i}function l(t){for(var e=new Uint8Array(t),i=new Array(e.length),r=0;r<e.length;r++)i[r]=String.fromCharCode(e[r]);return i.join("")}function c(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function u(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t,t)if("string"===typeof t)this._bodyText=t;else if(g.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(g.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(g.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(g.arrayBuffer&&g.blob&&m(t))this._bodyArrayBuffer=c(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!g.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!b(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=c(t)}else this._bodyText="";this.headers.get("content-type")||("string"===typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):g.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},g.blob&&(this.blob=function(){var t=n(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?n(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(a)}),this.text=function(){var t=n(this);if(t)return t;if(this._bodyBlob)return h(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(l(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},g.formData&&(this.formData=function(){return this.text().then(_)}),this.json=function(){return this.text().then(JSON.parse)},this}function p(t){var e=t.toUpperCase();return w.indexOf(e)>-1?e:t}function f(t,e){e=e||{};var i=e.body;if(t instanceof f){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new o(t.headers)),this.method=t.method,this.mode=t.mode,i||null==t._bodyInit||(i=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new o(e.headers)),this.method=p(e.method||this.method||"GET"),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&i)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(i)}function _(t){var e=new FormData;return t.trim().split("&").forEach(function(t){if(t){var i=t.split("="),r=i.shift().replace(/\+/g," "),o=i.join("=").replace(/\+/g," ");e.append(decodeURIComponent(r),decodeURIComponent(o))}}),e}function d(t){var e=new o;return t.split(/\r?\n/).forEach(function(t){var i=t.split(":"),r=i.shift().trim();if(r){var o=i.join(":").trim();e.append(r,o)}}),e}function y(t,e){e||(e={}),this.type="default",this.status="status"in e?e.status:200,this.ok=this.status>=200&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new o(e.headers),this.url=e.url||"",this._initBody(t)}if(!t.fetch){var g={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(g.arrayBuffer)var v=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],m=function(t){return t&&DataView.prototype.isPrototypeOf(t)},b=ArrayBuffer.isView||function(t){return t&&v.indexOf(Object.prototype.toString.call(t))>-1};o.prototype.append=function(t,r){t=e(t),r=i(r);var o=this.map[t];this.map[t]=o?o+","+r:r},o.prototype.delete=function(t){delete this.map[e(t)]},o.prototype.get=function(t){return t=e(t),this.has(t)?this.map[t]:null},o.prototype.has=function(t){return this.map.hasOwnProperty(e(t))},o.prototype.set=function(t,r){this.map[e(t)]=i(r)},o.prototype.forEach=function(t,e){for(var i in this.map)this.map.hasOwnProperty(i)&&t.call(e,this.map[i],i,this)},o.prototype.keys=function(){var t=[];return this.forEach(function(e,i){t.push(i)}),r(t)},o.prototype.values=function(){var t=[];return this.forEach(function(e){t.push(e)}),r(t)},o.prototype.entries=function(){var t=[];return this.forEach(function(e,i){t.push([i,e])}),r(t)},g.iterable&&(o.prototype[Symbol.iterator]=o.prototype.entries);var w=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];f.prototype.clone=function(){return new f(this,{body:this._bodyInit})},u.call(f.prototype),u.call(y.prototype),y.prototype.clone=function(){return new y(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new o(this.headers),url:this.url})},y.error=function(){var t=new y(null,{status:0,statusText:""});return t.type="error",t};var M=[301,302,303,307,308];y.redirect=function(t,e){if(-1===M.indexOf(e))throw new RangeError("Invalid status code");return new y(null,{status:e,headers:{location:t}})},t.Headers=o,t.Request=f,t.Response=y,t.fetch=function(t,e){return new Promise(function(i,r){var o=new f(t,e),n=new XMLHttpRequest;n.onload=function(){var t={status:n.status,statusText:n.statusText,headers:d(n.getAllResponseHeaders()||"")};t.url="responseURL"in n?n.responseURL:t.headers.get("X-Request-URL");var e="response"in n?n.response:n.responseText;i(new y(e,t))},n.onerror=function(){r(new TypeError("Network request failed"))},n.ontimeout=function(){r(new TypeError("Network request failed"))},n.open(o.method,o.url,!0),"include"===o.credentials&&(n.withCredentials=!0),"responseType"in n&&g.blob&&(n.responseType="blob"),o.headers.forEach(function(t,e){n.setRequestHeader(e,t)}),n.send("undefined"===typeof o._bodyInit?null:o._bodyInit)})},t.fetch.polyfill=!0}}("undefined"!==typeof self?self:this)},function(t,e,i){i(7),t.exports=i(8)}]);
//# sourceMappingURL=main.7de81c26.js.map